//#include <stdio.h>
#include <string.h>
#include <esp_log.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

#include "esp_lcd_panel_ops.h"
#include "esp_lcd_panel_io.h"
#include "esp_lcd_panel_vendor.h"
#include "driver/spi_master.h"

#define TAG "I3-MAIN"

#define PIN_NUM_SCLK     39 //4
#define PIN_NUM_DC       42 //41
#define PIN_NUM_CS       45 //39
#define PIN_NUM_MOSI     38 //2
#define PIN_NUM_MISO     40
#define FREQ       80000000
#define WIDTH           240
#define HEIGHT          320

/**
 * MAIN
 */
extern "C" void app_main(){
  esp_log_level_set(TAG, ESP_LOG_VERBOSE); //Log level (ESP_LOG_NONE|ESP_LOG_VERBOSE)
  //esp_log_level_set(I3_BLE_TAG, ESP_LOG_INFO);

  ESP_LOGI(TAG, "Bonjour :-)");

  //-----------------------
  //Bus SPI
  //-----------------------
  spi_bus_config_t buscfg = {
    .mosi_io_num     = PIN_NUM_MOSI,
    .miso_io_num     = PIN_NUM_MISO,
    .sclk_io_num     = PIN_NUM_SCLK,
    .quadwp_io_num   = -1,
    .quadhd_io_num   = -1,
    .max_transfer_sz = WIDTH * HEIGHT * sizeof(uint16_t),
  };

  ESP_ERROR_CHECK(
    spi_bus_initialize(SPI2_HOST, &buscfg, SPI_DMA_CH_AUTO)
  );
  ESP_LOGI(TAG, "SPI ok");

  //-----------------------
  //LCD
  //-----------------------
  esp_lcd_panel_io_handle_t io_handle = NULL;
  esp_lcd_panel_io_spi_config_t io_config = {
    .cs_gpio_num       = PIN_NUM_CS,
    .dc_gpio_num       = PIN_NUM_DC,
    .spi_mode          = 0,
    .pclk_hz           = FREQ,
    .trans_queue_depth = 10,
    .lcd_cmd_bits      = 8,
    .lcd_param_bits    = 8,
  };

  ESP_ERROR_CHECK(
    esp_lcd_new_panel_io_spi((esp_lcd_spi_bus_handle_t)SPI2_HOST, &io_config, &io_handle) // Attach the LCD to the SPI bus
  ); 
  ESP_LOGI(TAG, "LCD connected to SPI");

  esp_lcd_panel_handle_t panel_handle = NULL;
  esp_lcd_panel_dev_config_t panel_config = {
    .reset_gpio_num = -1,
    .rgb_endian = LCD_RGB_ENDIAN_BGR,
    .bits_per_pixel = 16,
  };

  ESP_ERROR_CHECK(
    esp_lcd_new_panel_st7789(io_handle, &panel_config, &panel_handle) // Configuration du panneau ST7789
  );
  ESP_LOGI(TAG, "LCD configuration ok");

  // Initialisation de l'écran
  ESP_ERROR_CHECK(esp_lcd_panel_reset(panel_handle));
  ESP_ERROR_CHECK(esp_lcd_panel_init(panel_handle));
  ESP_ERROR_CHECK(esp_lcd_panel_disp_on_off(panel_handle, true));

  ESP_LOGI(TAG, "LCD init ok");

  // Remplir l'écran avec une couleur de fond (par exemple, noir)
  uint16_t *buffer = (uint16_t*)heap_caps_malloc(WIDTH * HEIGHT * sizeof(uint16_t), MALLOC_CAP_DMA);
  memset(buffer, 0x0000, WIDTH * HEIGHT * sizeof(uint16_t)); // Noir
  ESP_ERROR_CHECK(esp_lcd_panel_draw_bitmap(panel_handle, 0, 0, WIDTH, HEIGHT, buffer));

  ESP_LOGI(TAG, "uh?");

  // Afficher "Hello World!" (exemple simple avec un texte bitmap)
  // Note : esp_lcd ne fournit pas de rendu de texte natif, voici une approche basique
  const uint16_t white = 0xFFFF; // Couleur blanche en RGB565
  for (int y = 100; y < 120; y++) {
      for (int x = 50; x < 150; x++) {
          buffer[y * WIDTH + x] = white; // Dessine un rectangle blanc comme pseudo-texte
      }
  }

  ESP_LOGI(TAG, "uh2?");

  ESP_ERROR_CHECK(esp_lcd_panel_draw_bitmap(panel_handle, 0, 0, WIDTH, HEIGHT, buffer));

  ESP_LOGI(TAG, "uh3?");

  for(;;){
    vTaskDelay (1000 / portTICK_PERIOD_MS);

    ESP_ERROR_CHECK(esp_lcd_panel_draw_bitmap(panel_handle, 0, 0, WIDTH, HEIGHT, buffer));
    ESP_LOGI(TAG, "Normalement, un dessin est apparu");
  }

    free(buffer);

}
